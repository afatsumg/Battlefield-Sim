# Docker Compose file for Battlefield Simulation Services
# Defines services: fusion_service, monitor_cli, sensor_uav, sensor_radar_1, sensor_radar_2

# Common environment variables are defined using YAML anchors for reuse.
x-common-env: &common-env
  FUSION_ADDR: "fusion_service:6000"
  SHARED_TRUTH_PATH: "/workspace/shared/ground_truth.txt"
  SIM_DURATION_SEC: ${SIM_DURATION_SEC:-30} 

services:
  fusion_service:
    build:
      context: .
      dockerfile: docker/dev.Dockerfile
    image: battlefield-sim:fusion
    volumes:
      - ./logs:/workspace/shared
    environment:
      <<: *common-env
    ports:
      - "6000:6000"
      - "6005:6005"
    command: bash -lc "mkdir -p /workspace/shared/logs && cd /workspace/build && ./services/fusion_service/fusion_service"
    restart: on-failure
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  monitor_cli:
    image: battlefield-sim:fusion
    build:
      context: .
      dockerfile: docker/dev.Dockerfile

    command: bash -lc "cd /workspace/build && ./services/monitor_cli/monitor_cli fusion_service:6005"
    depends_on:
      - fusion_service
    restart: on-failure

  sensor_uav:
    image: battlefield-sim:fusion
    build:
      context: .
      dockerfile: docker/dev.Dockerfile
    volumes:
      - ./logs:/workspace/shared
    environment:
      <<: *common-env
      UAV_START_LAT: ${UAV_LAT:-39.920}
      UAV_START_LON: ${UAV_LON:-32.850}
      UAV_SPEED: ${UAV_SPEED:-120.0}
      UAV_START_HEADING: ${UAV_HEADING:-90.0}
    command: bash -lc "cd /workspace/build && ./services/sensor_uav/sensor_uav"
    depends_on:
      - fusion_service
    restart: on-failure

  sensor_radar_1:
    image: battlefield-sim:fusion
    build:
      context: .
      dockerfile: docker/dev.Dockerfile
    volumes:
      - ./logs:/workspace/shared
    environment:
      <<: *common-env
      RADAR_ID: "TPS-77-LONG-RANGE"
      RADAR_LAT: 39.750
      RADAR_LON: 32.700
      RADAR_RANGE_SIGMA: 50.0
      RADAR_BEARING_SIGMA: 1.5
      RADAR_RCS_ACTIVE: "true"
      RADAR_SENSITIVITY: 1e-20
    command: bash -lc "cd /workspace/build && ./services/sensor_radar/sensor_radar"
    depends_on:
      - fusion_service
    restart: on-failure

  sensor_radar_2:
    image: battlefield-sim:fusion
    build:
      context: .
      dockerfile: docker/dev.Dockerfile
    volumes:
      - ./logs:/workspace/shared
    environment:
      <<: *common-env
      RADAR_ID: "AN-MPQ-53-PATRIOT" # Updated ID
      RADAR_LAT: 39.940
      RADAR_LON: 32.855
      RADAR_RANGE_SIGMA: 5.0   # High precision tracking
      RADAR_BEARING_SIGMA: 0.1 # High precision bearing
      RADAR_RCS_ACTIVE: "true"
      RADAR_SENSITIVITY: 1e-15 # More sensitive than previous setting
    command: bash -lc "cd /workspace/build && ./services/sensor_radar/sensor_radar"
    depends_on:
      - fusion_service
    restart: on-failure